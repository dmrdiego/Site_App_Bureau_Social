1) Vari√°veis de ambiente (Secrets) essenciais

No Replit, em Secrets (üîê), crie:

DATABASE_URL ‚Üí string do Postgres (Replit Postgres ou Neon).

NODE_ENV ‚Üí production no ambiente de Deployment (no editor pode ficar development).

(opcional) SESSION_SECRET ou JWT_SECRET ‚Üí para autentica√ß√£o/assinaturas.

(opcional) LOG_LEVEL ‚Üí info (prod) / debug (dev).

Dica: no Deployment do Replit, re-crie os secrets (eles n√£o migram automaticamente do workspace).

2) Migra√ß√µes autom√°ticas no boot (Drizzle)

Garanta que o servidor executa Drizzle push ao subir no Deployment (apenas em prod).
No server/index.ts (ou m√≥dulo de bootstrap), rode algo assim antes do app.listen:

if (process.env.NODE_ENV === "production") {
  const { execSync } = await import("node:child_process");
  try {
    execSync("npm run db:push", { stdio: "inherit" });
    console.log("[drizzle] db pushed");
  } catch (e) {
    console.error("[drizzle] db push failed:", e);
  }
}


Alternativa: crie um workflow no .replit que rode npm run db:push antes de iniciar (veja se√ß√£o 10).

3) Healthcheck e Debug seguros

Adicione duas rotas no Express:

app.get("/health", (_req, res) => res.json({ ok: true, time: Date.now() }));

app.get("/__debug", (req, res) => {
  // proteja com "chave" simples no query param em prod
  if (process.env.NODE_ENV === "production" && req.query.key !== process.env.SESSION_SECRET) {
    return res.status(403).send("forbidden");
  }
  res.json({
    node: process.version,
    env: {
      NODE_ENV: process.env.NODE_ENV,
      PORT: process.env.PORT,
      DATABASE_URL: !!process.env.DATABASE_URL,
    },
    time: new Date().toISOString(),
  });
});


Configure o healthcheck do Replit para GET /health (autoscale reinicia inst√¢ncias se necess√°rio).

O /__debug mantenha protegido (como no snippet) quando estiver publicado.

4) SPA fallback + assets est√°ticos (Vite build)

Na produ√ß√£o, sirva client/dist e fa√ßa fallback de rotas (Wouter/SPA):

import path from "node:path";
import express from "express";

const dist = path.join(process.cwd(), "dist");          // backend bundle
const clientDist = path.join(process.cwd(), "client", "dist"); // vite assets

app.use("/assets", express.static(path.join(clientDist, "assets"), {
  maxAge: "7d", etag: true, lastModified: true,
}));

// SPA fallback: devolve index.html para rotas n√£o-API
app.use((req, res, next) => {
  if (req.path.startsWith("/api")) return next();
  res.sendFile(path.join(clientDist, "index.html"));
});


Certifique-se que o seu build faz vite build antes de empacotar o servidor (j√° est√° no script).

5) Seguran√ßa r√°pida no Express

Instale e habilite:

npm i helmet compression express-rate-limit

import helmet from "helmet";
import compression from "compression";
import rateLimit from "express-rate-limit";

app.use(helmet({
  contentSecurityPolicy: false, // ative CSP se mapear assets externos com cuidado
}));
app.use(compression());
app.use(rateLimit({ windowMs: 60_000, max: 300 })); // 300 req/min/ip (ajuste conforme)
app.use(express.json({ limit: "1mb" }));

6) Logs e diagn√≥stico

Em dev: morgan("dev") (opcional)

Em prod: logs simples com console.log ou pino (melhor para autoscale).

Padronize n√≠vel via LOG_LEVEL.

Logue startup, porta, NODE_ENV, DB conectado e vers√£o.

app.listen(port, () => {
  console.log(`[server] up on :${port} env=${process.env.NODE_ENV}`);
});

7) Deploy ‚Äúautoscale‚Äù est√°vel (o .replit j√° ajuda)

O seu .replit j√° est√° bom:

[deployment] build = ["npm","run","build"] e run = ["npm","run","start"]

Porta 5000 ‚Üí 80

nodejs-20, web, postgresql-16 carregados

S√≥ reforce:

Secrets no ambiente de Deployment

Teste npm run build local no Replit antes do Deploy (pega erros de tipagem/build)

8) Dev UX no Replit

npm run dev j√° faz server TSX + Vite (√≥timo).

Se precisar proxy de API no Vite (quando o cliente aciona /api durante dev):

// vite.config.ts
server: {
  proxy: {
    "/api": "http://localhost:5000",
  },
}


(Se o seu dev server e Vite estiverem no mesmo processo via server/index.ts, talvez n√£o precise.)

9) Banco de dados (Postgres)

Com DATABASE_URL setado:

npm run db:push

(opcional) script seed:

// package.json
"scripts": { "seed": "tsx seed_documents.ts" }


E rode: npm run seed

Em produ√ß√£o: rode db:push automaticamente (se√ß√£o 2) ou via workflow de deploy (se√ß√£o 10).

10) Workflows no .replit (tarefas automatizadas)

Voc√™ j√° tem um bloco [[workflows.workflow]]. Sugest√µes para adicionar tasks:

[[workflows.workflow]]
name = "Deploy + DB"
author = "agent"

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm ci"
waitForPort = 0

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run db:push"
waitForPort = 0

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run build"
waitForPort = 0

[[workflows.workflow.tasks]]
task = "shell.exec"
args = "npm run start"
waitForPort = 5000


Use esse workflow quando voc√™ quiser ‚Äúsubir + aplicar schema + iniciar‚Äù num s√≥ clique/execu√ß√£o controlada.

11) Cache e performance

Assets: j√° servidos por Vite (minificados). Ative maxAge para /assets (feito na se√ß√£o 4).

Imagens: preferir WebP/AVIF e dimens√µes responsivas.

Tailwind: confirmar content correto no tailwind.config.ts para purgar CSS n√£o usado.

12) CORS (se for consumir da web p√∫blica)

Se o frontend e backend ficarem no mesmo dom√≠nio do Replit, n√£o precisa.
Se separar, ative CORS restrito:

npm i cors

import cors from "cors";
app.use(cors({
  origin: ["https://pt-bureausocial.replit.app"], // ajuste se houver outros
  credentials: true,
}));

13) Encerramento gracioso (autoscale)

Adicione handlers para SIGTERM/SIGINT:

const server = app.listen(port, () => { /* ... */ });

function shutdown() {
  console.log("[server] shutting down...");
  server.close(() => process.exit(0));
}
process.on("SIGTERM", shutdown);
process.on("SIGINT", shutdown);

14) Documenta√ß√£o (README)

Crie um README.md com:

Dev: npm i ‚Üí npm run dev

DB: setar DATABASE_URL, npm run db:push, npm run seed

Build/Prod: npm run build, npm run start

Health/Debug: /health e /__debug?key=<SESSION_SECRET>

15) Checagem final (checklist)

 DATABASE_URL configurado nos dois ambientes (editor e deployment)

 npm run db:push ok

 /health responde 200

 /__debug?key=... responde (em prod, protegido)

 npm run build e npm run start sobem sem erro

 Assets do Vite servindo /assets/* com cache

 SPA fallback entrega index.html nas rotas do Wouter

 helmet, compression, rate-limit ativos

 Logs de startup leg√≠veis (porta, env, DB ok)

Se quiser, eu te mando diffs prontos para:

adicionar /health + /__debug

habilitar helmet/compression/rate-limit

servir client/dist + SPA fallback

rodar db:push no boot (prod)

√â s√≥ dizer ‚Äúmanda os diffs‚Äù que eu entrego os patches certinhos para colar no teu server/index.ts e package.json.